<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Chat - Spring AI</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            /* ë·°í¬íŠ¸ ê³ ì •ìœ¼ë¡œ body ìŠ¤í¬ë¡¤ ë°©ì§€, í—¤ë”/ì‚¬ì´ë“œë°” ê³ ì • í›„ ì±„íŒ… ì˜ì—­ë§Œ ìŠ¤í¬ë¡¤ */
            body {
                font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
                background: #f8f9fa;
                height: 100vh;
                min-height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .header {
                flex-shrink: 0;
                min-height: 56px;
                background: #e8eaed;
                border-bottom: 1px solid #bdc1c6;
                padding: 16px 24px;
                display: flex;
                align-items: center;
                gap: 16px;
            }
            .header-title {
                color: #202124;
                font-size: 1.4em;
                font-weight: 400;
            }
            .header-logout {
                margin-left: auto;
            }
            .btn-logout {
                padding: 6px 14px;
                background: #5f6368;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.875em;
                font-weight: 500;
                cursor: pointer;
            }
            .btn-logout:hover {
                background: #4a4d52;
            }
            .main-layout {
                flex: 1;
                min-height: 0;
                display: flex;
                overflow: hidden;
            }
            .sidebar {
                flex-shrink: 0;
                width: 280px;
                background: #e8eaed;
                border-right: 1px solid #bdc1c6;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .sidebar-header {
                padding: 16px;
                border-bottom: 1px solid #bdc1c6;
            }
            .new-chat-btn {
                width: 100%;
                padding: 8px 14px;
                background: #1967d2;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.875em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            .new-chat-btn:hover {
                background: #1557b0;
            }
            .history-list {
                flex: 1;
                overflow-y: auto;
                padding: 8px;
            }
            .history-item {
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.2s;
                margin-bottom: 4px;
            }
            .history-item:hover {
                background: #f1f3f4;
            }
            .history-item.active {
                background: #e8f0fe;
            }
            .history-title {
                font-size: 0.9em;
                color: #202124;
                margin-bottom: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .history-meta {
                font-size: 0.75em;
                color: #5f6368;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .chat-container {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            /* ëŒ€í™” ë©”ì‹œì§€ ì˜ì—­ë§Œ ìŠ¤í¬ë¡¤, í—¤ë”/ì‚¬ì´ë“œë°”/ì…ë ¥ì°½ì€ ê³ ì • */
            .chat-area {
                flex: 1;
                min-height: 0;
                padding: 24px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            .message-card {
                background: white;
                border-radius: 12px;
                padding: 20px 24px;
                border: 1px solid #e8eaed;
                animation: fadeIn 0.3s ease;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .message-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 12px;
                color: #5f6368;
                font-size: 0.85em;
                font-weight: 500;
            }
            .message-icon {
                font-size: 1.2em;
            }
            .message-content {
                color: #202124;
                font-size: 0.95em;
                line-height: 1.6;
                word-wrap: break-word;
            }
            /* ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ìŠ¤íƒ€ì¼: ì œëª©Â·ë¦¬ìŠ¤íŠ¸Â·ì½”ë“œÂ·ì¸ìš©êµ¬Â·í…Œì´ë¸” */
            .message-content h1,
            .message-content h2,
            .message-content h3 {
                margin: 1em 0 0.5em;
                font-weight: 600;
            }
            .message-content h1 {
                font-size: 1.35em;
            }
            .message-content h2 {
                font-size: 1.2em;
            }
            .message-content h3 {
                font-size: 1.05em;
            }
            .message-content p {
                margin: 0.5em 0;
            }
            .message-content ul,
            .message-content ol {
                margin: 0.5em 0;
                padding-left: 1.5em;
            }
            .message-content li {
                margin: 0.25em 0;
            }
            .message-content pre {
                margin: 0.75em 0;
                padding: 12px;
                background: #f1f3f4;
                border-radius: 8px;
                overflow-x: auto;
            }
            .message-content code {
                background: #f1f3f4;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.9em;
            }
            .message-content pre code {
                background: none;
                padding: 0;
            }
            .message-content blockquote {
                margin: 0.5em 0;
                padding-left: 1em;
                border-left: 4px solid #dadce0;
                color: #5f6368;
            }
            .message-content table {
                border-collapse: collapse;
                margin: 0.75em 0;
                width: 100%;
            }
            .message-content th,
            .message-content td {
                border: 1px solid #e8eaed;
                padding: 8px 12px;
                text-align: left;
            }
            .message-content th {
                background: #f8f9fa;
                font-weight: 600;
            }
            .message-content a {
                color: #1967d2;
                text-decoration: none;
            }
            .message-content a:hover {
                text-decoration: underline;
            }
            .user-message {
                border-left: 3px solid #1967d2;
            }
            .ai-message {
                border-left: 3px solid #34a853;
            }
            .error-message {
                border-left: 3px solid #ea4335;
            }
            .error-message .message-content {
                color: #d93025;
            }
            .loading-message {
                border-left: 3px solid #fbbc04;
            }
            .loading-dots {
                display: inline-flex;
                gap: 4px;
                margin-left: 4px;
            }
            .loading-dots span {
                width: 6px;
                height: 6px;
                background: #5f6368;
                border-radius: 50%;
                animation: bounce 1.4s infinite ease-in-out both;
            }
            .loading-dots span:nth-child(1) {
                animation-delay: -0.32s;
            }
            .loading-dots span:nth-child(2) {
                animation-delay: -0.16s;
            }
            @keyframes bounce {
                0%,
                80%,
                100% {
                    transform: scale(0);
                }
                40% {
                    transform: scale(1);
                }
            }
            .placeholder {
                text-align: center;
                padding: 80px 20px;
                color: #5f6368;
                margin: auto;
            }
            .placeholder-icon {
                font-size: 4em;
                margin-bottom: 16px;
                opacity: 0.5;
            }
            .placeholder-text {
                font-size: 1.1em;
            }
            .input-area {
                flex-shrink: 0;
                background: white;
                border-top: 1px solid #e8eaed;
                padding: 16px 24px;
            }
            form {
                display: flex;
                gap: 12px;
                align-items: flex-end;
            }
            textarea {
                flex: 1;
                padding: 12px 16px;
                border: 1px solid #dadce0;
                border-radius: 8px;
                font-size: 0.95em;
                font-family: inherit;
                resize: vertical;
                min-height: 52px;
                max-height: 200px;
                transition: border-color 0.2s;
            }
            textarea:focus {
                outline: none;
                border-color: #1967d2;
            }
            textarea:disabled {
                background: #f8f9fa;
                cursor: not-allowed;
            }
            .btn {
                height: 52px;
                padding: 0 20px;
                background: #1967d2;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.875em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                white-space: nowrap;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .btn:hover:not(:disabled) {
                background: #1557b0;
            }
            .btn:active:not(:disabled) {
                background: #174ea6;
            }
            .btn:disabled {
                background: #dadce0;
                cursor: not-allowed;
            }
            .empty-history {
                text-align: center;
                padding: 40px 20px;
                color: #5f6368;
                font-size: 0.9em;
            }
            @media (max-width: 768px) {
                .sidebar {
                    position: fixed;
                    left: -280px;
                    top: 0;
                    bottom: 0;
                    z-index: 1000;
                    transition: left 0.3s;
                }
                .sidebar.open {
                    left: 0;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-title">AI Chat</div>
            <form th:action="@{/logout}" method="post" class="header-logout">
                <button type="submit" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>

        <div class="main-layout">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="newChatBtn">
                        <span>â•</span>
                        <span>ìƒˆ ëŒ€í™”</span>
                    </button>
                    <div style="height: 10px"></div>
                    <a
                        href="/rag/documents"
                        class="new-chat-btn"
                        style="background: #34a853; text-decoration: none">
                        <span>ğŸ“š</span>
                        <span>ë¬¸ì„œ ê´€ë¦¬</span>
                    </a>
                </div>
                <div class="history-list" id="historyList">
                    <div class="empty-history">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
            <div class="chat-container">
                <div class="chat-area" id="chatArea">
                    <div class="placeholder" id="placeholder">
                        <div class="placeholder-icon">ğŸ’¬</div>
                        <div class="placeholder-text">
                            ì™¼ìª½ì—ì„œ ëŒ€í™”ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <form id="chatForm">
                        <textarea
                            id="messageInput"
                            name="message"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            required
                            rows="1"></textarea>
                        <button type="submit" class="btn" id="sendButton">ì „ì†¡</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§: marked(íŒŒì‹±) + DOMPurify(XSS ë°©ì§€) -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
        <script>
            const chatArea = document.getElementById('chatArea');
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const placeholder = document.getElementById('placeholder');
            const historyList = document.getElementById('historyList');
            const newChatBtn = document.getElementById('newChatBtn');

            // Conversation ID ê´€ë¦¬
            let conversationId = localStorage.getItem('conversationId');
            if (!conversationId) {
                conversationId = crypto.randomUUID();
                localStorage.setItem('conversationId', conversationId);
            }

            // íˆìŠ¤í† ë¦¬ ëª©ë¡ ë¡œë“œ
            async function loadHistories() {
                try {
                    const response = await fetch('/api/chat/histories');
                    const histories = await response.json();

                    if (histories.length === 0) {
                        historyList.innerHTML =
                            '<div class="empty-history">ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                        return;
                    }

                    historyList.innerHTML = '';
                    histories.forEach((history) => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        if (history.conversationId === conversationId) {
                            item.classList.add('active');
                        }

                        const title = document.createElement('div');
                        title.className = 'history-title';
                        title.textContent = history.title;

                        const meta = document.createElement('div');
                        meta.className = 'history-meta';
                        const date = new Date(history.lastUpdated);
                        meta.innerHTML = `
                        <span>${formatDate(date)}</span>
                        <span>${history.messageCount}ê°œ</span>
                    `;

                        item.appendChild(title);
                        item.appendChild(meta);

                        item.addEventListener('click', (e) => {
                            selectHistory(history.conversationId, e.currentTarget);
                        });

                        historyList.appendChild(item);
                    });
                } catch (error) {
                    console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                    historyList.innerHTML = '<div class="empty-history">íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            }

            // ë‚ ì§œ í¬ë§·íŒ…
            function formatDate(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'ë°©ê¸ˆ ì „';
                if (minutes < 60) return `${minutes}ë¶„ ì „`;
                if (hours < 24) return `${hours}ì‹œê°„ ì „`;
                if (days < 7) return `${days}ì¼ ì „`;
                return date.toLocaleDateString('ko-KR');
            }

            // íˆìŠ¤í† ë¦¬ ì„ íƒ
            async function selectHistory(id, clickedElement) {
                conversationId = id;
                localStorage.setItem('conversationId', conversationId);

                // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.history-item').forEach((item) => {
                    item.classList.remove('active');
                });
                if (clickedElement) {
                    clickedElement.classList.add('active');
                }

                // ëŒ€í™” ë‚´ìš© ë¡œë“œ
                await loadHistoryMessages(id);

                // íˆìŠ¤í† ë¦¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadHistories();
            }

            // íŠ¹ì • íˆìŠ¤í† ë¦¬ì˜ ë©”ì‹œì§€ ë¡œë“œ
            async function loadHistoryMessages(id) {
                try {
                    const response = await fetch(`/api/chat/histories/${id}`);
                    const historyDetail = await response.json();

                    // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
                    chatArea.innerHTML = '';
                    if (placeholder) placeholder.remove();

                    // ë©”ì‹œì§€ í‘œì‹œ
                    historyDetail.messages.forEach((msg) => {
                        const type = msg.role === 'user' ? 'user' : 'ai';
                        addMessage(msg.content, type, false);
                    });

                    // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
                    chatArea.scrollTop = chatArea.scrollHeight;
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    addMessage('ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // ìƒˆ ëŒ€í™” ì‹œì‘
            newChatBtn.addEventListener('click', () => {
                conversationId = crypto.randomUUID();
                localStorage.setItem('conversationId', conversationId);

                // ì±„íŒ… ì˜ì—­ ì´ˆê¸°í™”
                chatArea.innerHTML = '';
                const newPlaceholder = document.createElement('div');
                newPlaceholder.className = 'placeholder';
                newPlaceholder.id = 'placeholder';
                newPlaceholder.innerHTML = `
                <div class="placeholder-icon">ğŸ’¬</div>
                <div class="placeholder-text">ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
            `;
                chatArea.appendChild(newPlaceholder);

                // íˆìŠ¤í† ë¦¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadHistories();
            });

            // ìë™ ë†’ì´ ì¡°ì ˆ
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
            function addMessage(content, type, scroll = true) {
                // placeholder ì œê±°
                const existingPlaceholder = document.getElementById('placeholder');
                if (existingPlaceholder) {
                    existingPlaceholder.remove();
                }

                const messageCard = document.createElement('div');
                messageCard.className = `message-card ${type}-message`;

                const header = document.createElement('div');
                header.className = 'message-header';

                const icon = document.createElement('span');
                icon.className = 'message-icon';

                const label = document.createElement('span');

                if (type === 'user') {
                    icon.textContent = 'ğŸ‘¤';
                    label.textContent = 'You';
                } else if (type === 'ai') {
                    icon.textContent = 'âœ¨';
                    label.textContent = 'AI';
                } else if (type === 'error') {
                    icon.textContent = 'âš ï¸';
                    label.textContent = 'Error';
                } else if (type === 'loading') {
                    icon.textContent = 'â³';
                    label.textContent = 'AI';
                }

                header.appendChild(icon);
                header.appendChild(label);

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                if (type === 'loading') {
                    messageContent.innerHTML =
                        'Thinking<span class="loading-dots"><span></span><span></span><span></span></span>';
                } else if (type === 'error') {
                    messageContent.textContent = content;
                } else {
                    // userÂ·ai ë©”ì‹œì§€: ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜ í›„ DOMPurifyë¡œ sanitize
                    const rawHtml =
                        typeof marked !== 'undefined'
                            ? marked.parse(content || '')
                            : (content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    messageContent.innerHTML =
                        typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rawHtml) : rawHtml;
                }

                messageCard.appendChild(header);
                messageCard.appendChild(messageContent);
                chatArea.appendChild(messageCard);

                // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
                if (scroll) {
                    chatArea.scrollTop = chatArea.scrollHeight;
                }

                return messageCard;
            }

            // í¼ ì œì¶œ ì²˜ë¦¬
            chatForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const message = messageInput.value.trim();
                if (!message) return;

                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                addMessage(message, 'user');

                // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ë¹„í™œì„±í™”
                messageInput.value = '';
                messageInput.style.height = 'auto';
                messageInput.disabled = true;
                sendButton.disabled = true;

                // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
                const loadingCard = addMessage('', 'loading');

                try {
                    // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ (conversationId í¬í•¨)
                    const response = await fetch('/api/chat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversationId: conversationId,
                        }),
                    });

                    const data = await response.json();

                    // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    loadingCard.remove();

                    if (data.success === 'true') {
                        // AI ì‘ë‹µ ì¶”ê°€
                        addMessage(data.response, 'ai');
                        // íˆìŠ¤í† ë¦¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadHistories();
                    } else {
                        // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
                        addMessage('AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error, 'error');
                    }
                } catch (error) {
                    // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    loadingCard.remove();
                    // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
                    addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                } finally {
                    // ì…ë ¥ì°½ í™œì„±í™”
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            });

            // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });

            // í˜ì´ì§€ ë¡œë“œ ì‹œ íˆìŠ¤í† ë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            loadHistories();

            // í˜„ì¬ conversationIdì— í•´ë‹¹í•˜ëŠ” íˆìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ ë¡œë“œ
            if (conversationId && conversationId !== 'default') {
                loadHistoryMessages(conversationId).catch(console.error);
            }
        </script>
    </body>
</html>
