<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RAG Documents - Spring AI</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
                background: #f8f9fa;
                min-height: 100vh;
                color: #202124;
            }
            .header {
                background: white;
                border-bottom: 1px solid #e8eaed;
                padding: 16px 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .header-title {
                font-size: 1.2em;
                font-weight: 500;
            }
            .header-actions a {
                color: #1967d2;
                text-decoration: none;
                font-size: 0.95em;
            }
            .container {
                max-width: 1080px;
                margin: 0 auto;
                padding: 24px;
            }
            .card {
                background: white;
                border: 1px solid #e8eaed;
                border-radius: 12px;
                padding: 20px 22px;
                margin-bottom: 16px;
            }
            .card-title {
                font-size: 1em;
                font-weight: 600;
                margin-bottom: 12px;
            }
            .row {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }
            .btn {
                padding: 10px 14px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.95em;
            }
            .btn-primary {
                background: #1967d2;
                color: white;
            }
            .btn-secondary {
                background: #5f6368;
                color: white;
            }
            .btn-danger {
                background: #d93025;
                color: white;
            }
            .btn:disabled {
                background: #dadce0;
                cursor: not-allowed;
            }
            .hint {
                font-size: 0.85em;
                color: #5f6368;
                margin-top: 8px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                border-top: 1px solid #e8eaed;
                padding: 12px 10px;
                text-align: left;
                vertical-align: middle;
                font-size: 0.92em;
            }
            th {
                background: #f8f9fa;
                font-weight: 600;
                border-top: none;
            }
            .title-cell {
                font-weight: 600;
            }
            .muted {
                color: #5f6368;
                font-size: 0.85em;
            }
            .status {
                margin-top: 10px;
                color: #5f6368;
                font-size: 0.9em;
                white-space: pre-wrap;
            }
            .badge {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                border: 1px solid #e8eaed;
                background: #fff;
                color: #5f6368;
                font-size: 0.8em;
            }
            .modal-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.45);
                display: none;
                align-items: center;
                justify-content: center;
                padding: 16px;
                z-index: 2000;
            }
            .modal {
                width: min(640px, 100%);
                background: white;
                border-radius: 12px;
                border: 1px solid #e8eaed;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
                padding: 18px 18px 16px;
            }
            .modal-title {
                font-size: 1em;
                font-weight: 700;
                margin-bottom: 10px;
            }
            .modal-desc {
                font-size: 0.9em;
                color: #5f6368;
                line-height: 1.5;
                margin-bottom: 12px;
            }
            .modal input[type='text'] {
                width: 100%;
                padding: 12px 14px;
                border: 1px solid #dadce0;
                border-radius: 8px;
                font-size: 0.95em;
            }
            .modal input[type='text']:focus {
                outline: none;
                border-color: #1967d2;
            }
            .modal-actions {
                margin-top: 12px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                flex-wrap: wrap;
            }
            .modal-backdrop.open {
                display: flex;
            }
            @media (max-width: 768px) {
                .container {
                    padding: 16px;
                }
                th:nth-child(4),
                td:nth-child(4) {
                    display: none;
                } /* docId 숨김 */
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-title">RAG 문서 관리</div>
            <div class="header-actions">
                <a href="/chat">← 채팅으로</a>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <div class="card-title">문서 업로드 (임베딩)</div>
                <div class="row">
                    <input
                        id="fileInput"
                        type="file"
                        multiple
                        accept=".txt,.md,.markdown,.pdf,text/plain,text/markdown,application/pdf" />
                    <button class="btn btn-primary" id="uploadBtn">업로드</button>
                </div>
                <div class="hint">
                    현재 업로드는 <span class="badge">.txt</span>, <span class="badge">.md</span>,
                    <span class="badge">.markdown</span>, <span class="badge">.pdf</span>를
                    허용하며, 여러 파일을 한 번에 업로드할 수 있습니다. PDF는 페이지 단위로 분리 후,
                    필요 시 OCR을 수행합니다.
                </div>
                <div class="status" id="status"></div>
            </div>

            <div class="card">
                <div class="card-title">URL 문서 적재 (임베딩)</div>
                <div class="row">
                    <button class="btn btn-secondary" id="openUrlDialogBtn">URL 입력</button>
                </div>
                <div class="hint">
                    단일 URL(인증/크롤링 제외)을 읽어서 적재합니다. <span class="badge">HTML</span>,
                    <span class="badge">PDF</span>, <span class="badge">Markdown</span>,
                    <span class="badge">TXT</span>는 자동 판별됩니다.
                </div>
            </div>

            <div class="card">
                <div class="row" style="justify-content: space-between; gap: 12px">
                    <div>
                        <div class="card-title" style="margin-bottom: 6px">벡터 DB 문서 목록</div>
                        <div class="muted">
                            표시 기준: vector_store 테이블의 청크들을 docId로 그룹핑
                        </div>
                    </div>
                    <div class="row">
                        <button class="btn btn-secondary" id="refreshBtn">새로고침</button>
                    </div>
                </div>
                <div style="height: 12px"></div>
                <div style="overflow-x: auto">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 24%">제목</th>
                                <th style="width: 20%">파일명</th>
                                <th style="width: 10%">청크</th>
                                <th style="width: 28%">docId</th>
                                <th style="width: 18%">작업</th>
                            </tr>
                        </thead>
                        <tbody id="docTbody">
                            <tr>
                                <td colspan="5" class="muted">로딩 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="modal-backdrop" id="urlModalBackdrop" aria-hidden="true">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="urlModalTitle">
                <div class="modal-title" id="urlModalTitle">URL 문서 적재</div>
                <div class="modal-desc">
                    단일 URL(인증/크롤링 제외)을 읽어서 벡터 DB에 적재합니다.
                    HTML/PDF/Markdown/TXT는 자동 판별됩니다.
                </div>
                <input
                    id="urlInput"
                    type="text"
                    placeholder="https://example.com/doc"
                    autocomplete="off" />
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelUrlBtn">취소</button>
                    <button class="btn btn-primary" id="ingestUrlBtn">적재</button>
                </div>
            </div>
        </div>

        <script>
            const statusEl = document.getElementById('status');
            const tbody = document.getElementById('docTbody');
            const uploadBtn = document.getElementById('uploadBtn');
            const openUrlDialogBtn = document.getElementById('openUrlDialogBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const fileInput = document.getElementById('fileInput');
            const urlModalBackdrop = document.getElementById('urlModalBackdrop');
            const urlInput = document.getElementById('urlInput');
            const cancelUrlBtn = document.getElementById('cancelUrlBtn');
            const ingestUrlBtn = document.getElementById('ingestUrlBtn');

            function setStatus(text) {
                statusEl.textContent = text || '';
            }

            async function loadDocs() {
                try {
                    tbody.innerHTML = '<tr><td colspan="5" class="muted">로딩 중...</td></tr>';
                    const res = await fetch('/api/rag/documents');
                    if (!res.ok) throw new Error(`목록 조회 실패 (${res.status})`);
                    const docs = await res.json();
                    if (!docs || docs.length === 0) {
                        tbody.innerHTML =
                            '<tr><td colspan="5" class="muted">문서가 없습니다</td></tr>';
                        return;
                    }
                    tbody.innerHTML = '';
                    for (const d of docs) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                    <td class="title-cell">${escapeHtml(d.title || '(untitled)')}</td>
                    <td>${escapeHtml(d.filename || '-')}</td>
                    <td>${Number(d.chunkCount || 0)}</td>
                    <td class="muted">${escapeHtml(d.docId || '-')}</td>
                    <td>
                        <button class="btn btn-danger" data-docid="${escapeHtmlAttr(
                            d.docId,
                        )}">삭제</button>
                    </td>
                `;
                        tr.querySelector('button').addEventListener('click', async () => {
                            await deleteDoc(d.docId);
                        });
                        tbody.appendChild(tr);
                    }
                } catch (e) {
                    tbody.innerHTML = `<tr><td colspan="5" class="muted">오류: ${escapeHtml(
                        e.message,
                    )}</td></tr>`;
                }
            }

            async function upload() {
                const files = fileInput.files ? Array.from(fileInput.files) : [];
                if (files.length === 0) {
                    setStatus('파일을 선택해 주세요.');
                    return;
                }
                uploadBtn.disabled = true;
                openUrlDialogBtn.disabled = true;
                refreshBtn.disabled = true;
                setStatus(`업로드/임베딩 중: ${files.length}개 파일`);

                try {
                    const form = new FormData();
                    for (const f of files) {
                        form.append('file', f);
                    }
                    const res = await fetch('/api/rag/documents/upload', {
                        method: 'POST',
                        body: form,
                    });
                    if (!res.ok) {
                        const msg = await readErrorMessage(res);
                        throw new Error(`업로드 실패 (${res.status}): ${msg || res.statusText}`);
                    }
                    const data = await res.json();
                    setStatus(formatUploadStatus(data, files.length));
                    fileInput.value = '';
                    await loadDocs();
                } catch (e) {
                    setStatus(`적재 실패: ${e.message}`);
                } finally {
                    uploadBtn.disabled = false;
                    openUrlDialogBtn.disabled = false;
                    refreshBtn.disabled = false;
                }
            }

            function formatUploadStatus(data, selectedCount) {
                // 멀티 업로드 상세 응답 지원: { succeededFiles, failedFiles, totalChunksIngested, results[] }
                if (data && Array.isArray(data.results)) {
                    const succeeded = Number(data.succeededFiles || 0);
                    const failed = Number(data.failedFiles || 0);
                    const skipped = Number(data.skippedFiles || 0);
                    const totalChunks = Number(data.totalChunksIngested || 0);

                    let text = `적재 완료: 선택 ${selectedCount}개 (성공 ${succeeded} / 실패 ${failed} / 스킵 ${skipped})\n총 청크: ${totalChunks}개`;
                    if (failed > 0) {
                        const failedLines = data.results
                            .filter((r) => r && r.status === 'FAILED')
                            .map((r) => `- ${r.filename || '(unknown)'}: ${r.error || '실패'}`);
                        if (failedLines.length > 0) {
                            text += `\n\n실패 목록:\n${failedLines.join('\n')}`;
                        }
                    }
                    return text;
                }

                // 구형 응답 fallback: { chunksIngested }
                return `적재 완료: ${selectedCount}개 파일 (청크 ${Number(
                    data?.chunksIngested || 0,
                )}개)`;
            }

            function openUrlModal() {
                urlModalBackdrop.classList.add('open');
                urlModalBackdrop.setAttribute('aria-hidden', 'false');
                urlInput.value = '';
                setTimeout(() => urlInput.focus(), 0);
            }

            function closeUrlModal() {
                urlModalBackdrop.classList.remove('open');
                urlModalBackdrop.setAttribute('aria-hidden', 'true');
                urlInput.value = '';
            }

            async function ingestUrl() {
                const url = (urlInput.value || '').trim();
                if (!url) {
                    setStatus('URL을 입력해 주세요.');
                    return;
                }

                uploadBtn.disabled = true;
                openUrlDialogBtn.disabled = true;
                refreshBtn.disabled = true;
                ingestUrlBtn.disabled = true;
                cancelUrlBtn.disabled = true;
                setStatus(`URL 적재 중: ${url}`);

                try {
                    const res = await fetch('/api/rag/documents/url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });

                    if (!res.ok) {
                        const msg = await readErrorMessage(res);
                        throw new Error(`URL 적재 실패 (${res.status}): ${msg || res.statusText}`);
                    }

                    const data = await res.json();
                    setStatus(`적재 완료: ${data.title || url} (청크 ${data.chunksIngested}개)`);
                    closeUrlModal();
                    await loadDocs();
                } catch (e) {
                    setStatus(`URL 적재 실패: ${e.message}`);
                } finally {
                    uploadBtn.disabled = false;
                    openUrlDialogBtn.disabled = false;
                    refreshBtn.disabled = false;
                    ingestUrlBtn.disabled = false;
                    cancelUrlBtn.disabled = false;
                }
            }

            async function readErrorMessage(res) {
                const ct = (res.headers.get('content-type') || '').toLowerCase();
                try {
                    if (ct.includes('application/json')) {
                        const j = await res.json();
                        if (j && typeof j.error === 'string') return j.error;
                        return JSON.stringify(j);
                    }
                    return await res.text();
                } catch (_) {
                    return '';
                }
            }

            async function deleteDoc(docId) {
                if (!docId) return;
                if (!confirm('이 문서를 삭제할까요? (관련 청크가 함께 삭제됩니다)')) return;
                try {
                    const res = await fetch(`/api/rag/documents/${encodeURIComponent(docId)}`, {
                        method: 'DELETE',
                    });
                    if (!res.ok && res.status !== 204) {
                        const t = await res.text();
                        throw new Error(`삭제 실패 (${res.status}): ${t || res.statusText}`);
                    }
                    setStatus('삭제 완료');
                    await loadDocs();
                } catch (e) {
                    setStatus(`삭제 실패: ${e.message}`);
                }
            }

            function escapeHtml(s) {
                return String(s ?? '').replace(
                    /[&<>"']/g,
                    (c) =>
                        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[
                            c
                        ]),
                );
            }
            function escapeHtmlAttr(s) {
                return escapeHtml(s).replace(/`/g, '&#96;');
            }

            uploadBtn.addEventListener('click', upload);
            openUrlDialogBtn.addEventListener('click', openUrlModal);
            cancelUrlBtn.addEventListener('click', closeUrlModal);
            ingestUrlBtn.addEventListener('click', ingestUrl);
            urlModalBackdrop.addEventListener('click', (e) => {
                if (e.target === urlModalBackdrop) closeUrlModal();
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && urlModalBackdrop.classList.contains('open')) {
                    closeUrlModal();
                }
            });
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ingestUrl();
                }
            });
            refreshBtn.addEventListener('click', loadDocs);
            loadDocs();
        </script>
    </body>
</html>
