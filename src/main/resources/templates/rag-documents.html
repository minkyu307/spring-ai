<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Documents - Spring AI</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #202124;
        }
        .header {
            background: white;
            border-bottom: 1px solid #e8eaed;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { font-size: 1.2em; font-weight: 500; }
        .header-actions a {
            color: #1967d2;
            text-decoration: none;
            font-size: 0.95em;
        }
        .container {
            max-width: 1080px;
            margin: 0 auto;
            padding: 24px;
        }
        .card {
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            padding: 20px 22px;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 1.0em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .btn-primary { background: #1967d2; color: white; }
        .btn-secondary { background: #5f6368; color: white; }
        .btn-danger { background: #d93025; color: white; }
        .btn:disabled { background: #dadce0; cursor: not-allowed; }
        .hint { font-size: 0.85em; color: #5f6368; margin-top: 8px; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border-top: 1px solid #e8eaed;
            padding: 12px 10px;
            text-align: left;
            vertical-align: middle;
            font-size: 0.92em;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            border-top: none;
        }
        .title-cell { font-weight: 600; }
        .muted { color: #5f6368; font-size: 0.85em; }
        .status { margin-top: 10px; color: #5f6368; font-size: 0.9em; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #e8eaed;
            background: #fff;
            color: #5f6368;
            font-size: 0.8em;
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            th:nth-child(4), td:nth-child(4) { display: none; } /* docId 숨김 */
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-title">RAG 문서 관리</div>
    <div class="header-actions">
        <a href="/chat">← 채팅으로</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <div class="card-title">문서 업로드 (임베딩)</div>
        <div class="row">
            <input id="fileInput" type="file" accept=".txt,.md,.markdown,text/plain,text/markdown" />
            <button class="btn btn-primary" id="uploadBtn">업로드</button>
            <button class="btn btn-secondary" id="refreshBtn">새로고침</button>
        </div>
        <div class="hint">현재 업로드는 <span class="badge">.txt</span>, <span class="badge">.md</span>, <span class="badge">.markdown</span>만 허용됩니다.</div>
        <div class="status" id="status"></div>
    </div>

    <div class="card">
        <div class="card-title">벡터 DB 문서 목록</div>
        <div class="muted">표시 기준: vector_store 테이블의 청크들을 docId로 그룹핑</div>
        <div style="height: 12px;"></div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                <tr>
                    <th style="width: 24%;">제목</th>
                    <th style="width: 20%;">파일명</th>
                    <th style="width: 10%;">청크</th>
                    <th style="width: 28%;">docId</th>
                    <th style="width: 18%;">작업</th>
                </tr>
                </thead>
                <tbody id="docTbody">
                <tr><td colspan="5" class="muted">로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const tbody = document.getElementById('docTbody');
    const uploadBtn = document.getElementById('uploadBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const fileInput = document.getElementById('fileInput');

    function setStatus(text) {
        statusEl.textContent = text || '';
    }

    async function loadDocs() {
        try {
            tbody.innerHTML = '<tr><td colspan="5" class="muted">로딩 중...</td></tr>';
            const res = await fetch('/api/rag/documents');
            if (!res.ok) throw new Error(`목록 조회 실패 (${res.status})`);
            const docs = await res.json();
            if (!docs || docs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="muted">문서가 없습니다</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            for (const d of docs) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="title-cell">${escapeHtml(d.title || '(untitled)')}</td>
                    <td>${escapeHtml(d.filename || '-')}</td>
                    <td>${Number(d.chunkCount || 0)}</td>
                    <td class="muted">${escapeHtml(d.docId || '-')}</td>
                    <td>
                        <button class="btn btn-danger" data-docid="${escapeHtmlAttr(d.docId)}">삭제</button>
                    </td>
                `;
                tr.querySelector('button').addEventListener('click', async () => {
                    await deleteDoc(d.docId);
                });
                tbody.appendChild(tr);
            }
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="5" class="muted">오류: ${escapeHtml(e.message)}</td></tr>`;
        }
    }

    async function upload() {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
            setStatus('파일을 선택해 주세요.');
            return;
        }
        uploadBtn.disabled = true;
        refreshBtn.disabled = true;
        setStatus(`업로드/임베딩 중: ${file.name}`);

        try {
            const form = new FormData();
            form.append('file', file);
            const res = await fetch('/api/rag/documents/upload', { method: 'POST', body: form });
            if (!res.ok) {
                const t = await res.text();
                throw new Error(`업로드 실패 (${res.status}): ${t || res.statusText}`);
            }
            const data = await res.json();
            setStatus(`적재 완료: ${file.name} (청크 ${data.chunksIngested}개)`);
            fileInput.value = '';
            await loadDocs();
        } catch (e) {
            setStatus(`적재 실패: ${e.message}`);
        } finally {
            uploadBtn.disabled = false;
            refreshBtn.disabled = false;
        }
    }

    async function deleteDoc(docId) {
        if (!docId) return;
        if (!confirm('이 문서를 삭제할까요? (관련 청크가 함께 삭제됩니다)')) return;
        try {
            const res = await fetch(`/api/rag/documents/${encodeURIComponent(docId)}`, { method: 'DELETE' });
            if (!res.ok && res.status !== 204) {
                const t = await res.text();
                throw new Error(`삭제 실패 (${res.status}): ${t || res.statusText}`);
            }
            setStatus('삭제 완료');
            await loadDocs();
        } catch (e) {
            setStatus(`삭제 실패: ${e.message}`);
        }
    }

    function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, c => (
            { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]
        ));
    }
    function escapeHtmlAttr(s) {
        return escapeHtml(s).replace(/`/g, '&#96;');
    }

    uploadBtn.addEventListener('click', upload);
    refreshBtn.addEventListener('click', loadDocs);
    loadDocs();
</script>
</body>
</html>

