<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RAG Documents - Spring AI</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
                background: #f8f9fa;
                min-height: 100vh;
                color: #202124;
                padding-top: 56px;
            }
            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                min-height: 56px;
                background: #e8eaed;
                border-bottom: 1px solid #bdc1c6;
                padding: 16px 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .header-title {
                color: #202124;
                font-size: 1.4em;
                font-weight: 400;
            }
            .btn-logout {
                padding: 6px 14px;
                background: #5f6368;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.875em;
                font-weight: 500;
                cursor: pointer;
            }
            .btn-logout:hover {
                background: #4a4d52;
            }
            /* êµ¬ë¶„ì„  ì „ì²´ ë„ˆë¹„ + ë²„íŠ¼ êµ¬ì—­ íŒ¨ë”©ì€ chat.html sidebar-headerì™€ ë™ì¼(16px) */
            .sidebar-header {
                padding: 16px;
                border-bottom: 1px solid #bdc1c6;
                margin-bottom: 8px;
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
            }
            .sidebar-nav-btn {
                width: 100%;
                padding: 8px 14px;
                background: #34a853;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.875em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                text-decoration: none;
                box-sizing: border-box;
            }
            .sidebar-nav-btn:hover {
                background: #2d8e47;
            }
            .main-layout {
                display: flex;
                min-height: calc(100vh - 56px);
            }
            .sidebar {
                position: fixed;
                left: 0;
                top: 56px;
                bottom: 0;
                width: 280px;
                background: #e8eaed;
                border-right: 1px solid #bdc1c6;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 16px;
                flex-shrink: 0;
            }
            .sidebar .card {
                margin-bottom: 16px;
            }
            .sidebar .card:last-child {
                margin-bottom: 0;
            }
            .main-content {
                margin-left: 280px;
                flex: 1;
                padding: 24px;
                min-width: 0;
            }
            .card {
                background: white;
                border: 1px solid #e8eaed;
                border-radius: 12px;
                padding: 20px 22px;
                margin-bottom: 16px;
            }
            .card-title {
                font-size: 1em;
                font-weight: 600;
                margin-bottom: 12px;
            }
            .sidebar .card-desc {
                margin-top: 12px;
                padding: 10px 12px;
                font-size: 0.85em;
                color: #3c4043;
                background: #f1f3f4;
                border-radius: 8px;
                border-left: 3px solid #1967d2;
                line-height: 1.5;
            }
            .row {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }
            .btn {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.875em;
                font-weight: 500;
                transition: background 0.2s, opacity 0.2s;
            }
            .btn-primary {
                background: #1967d2;
                color: white;
            }
            .btn-primary:hover:not(:disabled) {
                background: #1557b0;
            }
            .btn-secondary {
                background: #5f6368;
                color: white;
            }
            .btn-secondary:hover:not(:disabled) {
                background: #4a4d52;
            }
            .btn-danger {
                background: #d93025;
                color: white;
            }
            .btn-danger:hover:not(:disabled) {
                background: #b71c1c;
            }
            .btn:disabled {
                background: #dadce0;
                cursor: not-allowed;
            }
            .hint {
                font-size: 0.85em;
                color: #5f6368;
                margin-top: 8px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                border-top: 1px solid #e8eaed;
                padding: 12px 10px;
                text-align: left;
                vertical-align: middle;
                font-size: 0.92em;
            }
            th {
                background: #f8f9fa;
                font-weight: 600;
                border-top: none;
            }
            .title-cell {
                font-weight: 600;
            }
            .muted {
                color: #5f6368;
                font-size: 0.85em;
            }
            .status {
                margin-top: 10px;
                color: #5f6368;
                font-size: 0.9em;
                white-space: pre-wrap;
            }
            .badge {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                border: 1px solid #e8eaed;
                background: #fff;
                color: #5f6368;
                font-size: 0.8em;
            }
            .modal-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.45);
                display: none;
                align-items: center;
                justify-content: center;
                padding: 16px;
                z-index: 2000;
            }
            .modal {
                width: min(640px, 100%);
                background: white;
                border-radius: 12px;
                border: 1px solid #e8eaed;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
                padding: 18px 18px 16px;
            }
            .modal-title {
                font-size: 1em;
                font-weight: 700;
                margin-bottom: 10px;
            }
            .modal-desc {
                font-size: 0.9em;
                color: #5f6368;
                line-height: 1.5;
                margin-bottom: 12px;
            }
            .modal input[type='text'] {
                width: 100%;
                padding: 12px 14px;
                border: 1px solid #dadce0;
                border-radius: 8px;
                font-size: 0.95em;
            }
            .modal input[type='text']:focus {
                outline: none;
                border-color: #1967d2;
            }
            .modal-actions {
                margin-top: 12px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                flex-wrap: wrap;
            }
            .modal-backdrop.open {
                display: flex;
            }
            @media (max-width: 768px) {
                .sidebar {
                    position: relative;
                    width: 100%;
                    top: auto;
                    bottom: auto;
                    border-right: none;
                    border-bottom: 1px solid #e8eaed;
                }
                .main-content {
                    margin-left: 0;
                    padding: 16px;
                }
                th:nth-child(4),
                td:nth-child(4) {
                    display: none;
                } /* docId ìˆ¨ê¹€ */
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-title">RAG ë¬¸ì„œ ê´€ë¦¬</div>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>

        <div class="main-layout">
            <aside class="sidebar" aria-label="ë¬¸ì„œ ì ì¬">
                <div class="sidebar-header">
                    <a href="/chat" class="sidebar-nav-btn">
                        <span>ğŸ’¬</span>
                        <span>ì±„íŒ…ìœ¼ë¡œ</span>
                    </a>
                </div>
                <div class="card">
                    <div class="row">
                        <input
                            id="fileInput"
                            type="file"
                            multiple
                            accept=".txt,.md,.markdown,.pdf,.docx,.pptx,text/plain,text/markdown,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.presentationml.presentation"
                            style="
                                position: absolute;
                                width: 0;
                                height: 0;
                                opacity: 0;
                                pointer-events: none;
                            " />
                        <button class="btn btn-primary" id="uploadBtn" type="button">
                            íŒŒì¼ ì—…ë¡œë“œ
                        </button>
                    </div>
                    <div class="card-desc">
                        <span class="badge">.txt</span>, <span class="badge">.md</span>,
                        <span class="badge">.markdown</span>, <span class="badge">.pdf</span>,
                        <span class="badge">.docx</span>, <span class="badge">.pptx</span>ë¥¼
                        í—ˆìš©í•˜ë©°, ì—¬ëŸ¬ íŒŒì¼ì„ í•œ ë²ˆì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. PDFëŠ” í˜ì´ì§€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
                        í›„, í•„ìš” ì‹œ OCRì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                    </div>
                    <div class="status" id="status"></div>
                </div>

                <div class="card">
                    <div class="row">
                        <button class="btn btn-primary" id="openUrlDialogBtn">URL ì—…ë¡œë“œ</button>
                    </div>
                    <div class="card-desc">
                        ë‹¨ì¼ URL(ì¸ì¦/í¬ë¡¤ë§ ì œì™¸)ì„ ì½ì–´ì„œ ì ì¬í•©ë‹ˆë‹¤.
                        <span class="badge">HTML</span>, <span class="badge">PDF</span>,
                        <span class="badge">Markdown</span>, <span class="badge">TXT</span>ëŠ” ìë™
                        íŒë³„ë©ë‹ˆë‹¤.
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div class="card">
                    <div class="row" style="justify-content: space-between; gap: 12px">
                        <div>
                            <div class="card-title" style="margin-bottom: 6px">
                                ë²¡í„° DB ë¬¸ì„œ ëª©ë¡
                            </div>
                            <div class="muted">
                                í‘œì‹œ ê¸°ì¤€: vector_store í…Œì´ë¸”ì˜ ì²­í¬ë“¤ì„ docIdë¡œ ê·¸ë£¹í•‘
                            </div>
                        </div>
                        <div class="row">
                            <button class="btn btn-secondary" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div style="height: 12px"></div>
                    <div style="overflow-x: auto">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 24%">ì œëª©</th>
                                    <th style="width: 20%">íŒŒì¼ëª…</th>
                                    <th style="width: 10%">ì²­í¬</th>
                                    <th style="width: 28%">docId</th>
                                    <th style="width: 18%">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="docTbody">
                                <tr>
                                    <td colspan="5" class="muted">ë¡œë”© ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <div class="modal-backdrop" id="urlModalBackdrop" aria-hidden="true">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="urlModalTitle">
                <div class="modal-title" id="urlModalTitle">URL ë¬¸ì„œ ì ì¬</div>
                <div class="modal-desc">
                    ë‹¨ì¼ URL(ì¸ì¦/í¬ë¡¤ë§ ì œì™¸)ì„ ì½ì–´ì„œ ë²¡í„° DBì— ì ì¬í•©ë‹ˆë‹¤.
                    HTML/PDF/Markdown/TXTëŠ” ìë™ íŒë³„ë©ë‹ˆë‹¤.
                </div>
                <input
                    id="urlInput"
                    type="text"
                    placeholder="https://example.com/doc"
                    autocomplete="off" />
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelUrlBtn">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" id="ingestUrlBtn">ì ì¬</button>
                </div>
            </div>
        </div>

        <script>
            const statusEl = document.getElementById('status');
            const tbody = document.getElementById('docTbody');
            const uploadBtn = document.getElementById('uploadBtn');
            const openUrlDialogBtn = document.getElementById('openUrlDialogBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const fileInput = document.getElementById('fileInput');
            const urlModalBackdrop = document.getElementById('urlModalBackdrop');
            const urlInput = document.getElementById('urlInput');
            const cancelUrlBtn = document.getElementById('cancelUrlBtn');
            const ingestUrlBtn = document.getElementById('ingestUrlBtn');

            function setStatus(text) {
                statusEl.textContent = text || '';
            }

            async function loadDocs() {
                try {
                    tbody.innerHTML = '<tr><td colspan="5" class="muted">ë¡œë”© ì¤‘...</td></tr>';
                    const res = await fetch('/api/rag/documents');
                    if (!res.ok) throw new Error(`ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (${res.status})`);
                    const docs = await res.json();
                    if (!docs || docs.length === 0) {
                        tbody.innerHTML =
                            '<tr><td colspan="5" class="muted">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                        return;
                    }
                    tbody.innerHTML = '';
                    for (const d of docs) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                    <td class="title-cell">${escapeHtml(d.title || '(untitled)')}</td>
                    <td>${escapeHtml(d.filename || '-')}</td>
                    <td>${Number(d.chunkCount || 0)}</td>
                    <td class="muted">${escapeHtml(d.docId || '-')}</td>
                    <td>
                        <button class="btn btn-danger" data-docid="${escapeHtmlAttr(
                            d.docId,
                        )}">ì‚­ì œ</button>
                    </td>
                `;
                        tr.querySelector('button').addEventListener('click', async () => {
                            await deleteDoc(d.docId);
                        });
                        tbody.appendChild(tr);
                    }
                } catch (e) {
                    tbody.innerHTML = `<tr><td colspan="5" class="muted">ì˜¤ë¥˜: ${escapeHtml(
                        e.message,
                    )}</td></tr>`;
                }
            }

            async function upload() {
                const files = fileInput.files ? Array.from(fileInput.files) : [];
                if (files.length === 0) {
                    setStatus('íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }
                uploadBtn.disabled = true;
                openUrlDialogBtn.disabled = true;
                refreshBtn.disabled = true;
                setStatus(`ì—…ë¡œë“œ/ì„ë² ë”© ì¤‘: ${files.length}ê°œ íŒŒì¼`);

                try {
                    const form = new FormData();
                    for (const f of files) {
                        form.append('file', f);
                    }
                    const res = await fetch('/api/rag/documents/upload', {
                        method: 'POST',
                        body: form,
                    });
                    if (!res.ok) {
                        const msg = await readErrorMessage(res);
                        throw new Error(`ì—…ë¡œë“œ ì‹¤íŒ¨ (${res.status}): ${msg || res.statusText}`);
                    }
                    const data = await res.json();
                    setStatus(formatUploadStatus(data, files.length));
                    fileInput.value = '';
                    await loadDocs();
                } catch (e) {
                    setStatus(`ì ì¬ ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    uploadBtn.disabled = false;
                    openUrlDialogBtn.disabled = false;
                    refreshBtn.disabled = false;
                }
            }

            function formatUploadStatus(data, selectedCount) {
                // ë©€í‹° ì—…ë¡œë“œ ìƒì„¸ ì‘ë‹µ ì§€ì›: { succeededFiles, failedFiles, totalChunksIngested, results[] }
                if (data && Array.isArray(data.results)) {
                    const succeeded = Number(data.succeededFiles || 0);
                    const failed = Number(data.failedFiles || 0);
                    const skipped = Number(data.skippedFiles || 0);
                    const totalChunks = Number(data.totalChunksIngested || 0);

                    let text = `ì ì¬ ì™„ë£Œ: ì„ íƒ ${selectedCount}ê°œ (ì„±ê³µ ${succeeded} / ì‹¤íŒ¨ ${failed} / ìŠ¤í‚µ ${skipped})\nì´ ì²­í¬: ${totalChunks}ê°œ`;
                    if (failed > 0) {
                        const failedLines = data.results
                            .filter((r) => r && r.status === 'FAILED')
                            .map((r) => `- ${r.filename || '(unknown)'}: ${r.error || 'ì‹¤íŒ¨'}`);
                        if (failedLines.length > 0) {
                            text += `\n\nì‹¤íŒ¨ ëª©ë¡:\n${failedLines.join('\n')}`;
                        }
                    }
                    return text;
                }

                // êµ¬í˜• ì‘ë‹µ fallback: { chunksIngested }
                return `ì ì¬ ì™„ë£Œ: ${selectedCount}ê°œ íŒŒì¼ (ì²­í¬ ${Number(
                    data?.chunksIngested || 0,
                )}ê°œ)`;
            }

            function openUrlModal() {
                urlModalBackdrop.classList.add('open');
                urlModalBackdrop.setAttribute('aria-hidden', 'false');
                urlInput.value = '';
                setTimeout(() => urlInput.focus(), 0);
            }

            function closeUrlModal() {
                urlModalBackdrop.classList.remove('open');
                urlModalBackdrop.setAttribute('aria-hidden', 'true');
                urlInput.value = '';
            }

            async function ingestUrl() {
                const url = (urlInput.value || '').trim();
                if (!url) {
                    setStatus('URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    return;
                }

                uploadBtn.disabled = true;
                openUrlDialogBtn.disabled = true;
                refreshBtn.disabled = true;
                ingestUrlBtn.disabled = true;
                cancelUrlBtn.disabled = true;
                setStatus(`URL ì ì¬ ì¤‘: ${url}`);

                try {
                    const res = await fetch('/api/rag/documents/url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });

                    if (!res.ok) {
                        const msg = await readErrorMessage(res);
                        throw new Error(`URL ì ì¬ ì‹¤íŒ¨ (${res.status}): ${msg || res.statusText}`);
                    }

                    const data = await res.json();
                    setStatus(`ì ì¬ ì™„ë£Œ: ${data.title || url} (ì²­í¬ ${data.chunksIngested}ê°œ)`);
                    closeUrlModal();
                    await loadDocs();
                } catch (e) {
                    setStatus(`URL ì ì¬ ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    uploadBtn.disabled = false;
                    openUrlDialogBtn.disabled = false;
                    refreshBtn.disabled = false;
                    ingestUrlBtn.disabled = false;
                    cancelUrlBtn.disabled = false;
                }
            }

            async function readErrorMessage(res) {
                const ct = (res.headers.get('content-type') || '').toLowerCase();
                try {
                    if (ct.includes('application/json')) {
                        const j = await res.json();
                        if (j && typeof j.error === 'string') return j.error;
                        return JSON.stringify(j);
                    }
                    return await res.text();
                } catch (_) {
                    return '';
                }
            }

            async function deleteDoc(docId) {
                if (!docId) return;
                if (!confirm('ì´ ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”? (ê´€ë ¨ ì²­í¬ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
                try {
                    const res = await fetch(`/api/rag/documents/${encodeURIComponent(docId)}`, {
                        method: 'DELETE',
                    });
                    if (!res.ok && res.status !== 204) {
                        const t = await res.text();
                        throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status}): ${t || res.statusText}`);
                    }
                    setStatus('ì‚­ì œ ì™„ë£Œ');
                    await loadDocs();
                } catch (e) {
                    setStatus(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`);
                }
            }

            function escapeHtml(s) {
                return String(s ?? '').replace(
                    /[&<>"']/g,
                    (c) =>
                        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[
                            c
                        ]),
                );
            }
            function escapeHtmlAttr(s) {
                return escapeHtml(s).replace(/`/g, '&#96;');
            }

            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                if (fileInput.files && fileInput.files.length > 0) upload();
            });
            openUrlDialogBtn.addEventListener('click', openUrlModal);
            cancelUrlBtn.addEventListener('click', closeUrlModal);
            ingestUrlBtn.addEventListener('click', ingestUrl);
            urlModalBackdrop.addEventListener('click', (e) => {
                if (e.target === urlModalBackdrop) closeUrlModal();
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && urlModalBackdrop.classList.contains('open')) {
                    closeUrlModal();
                }
            });
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ingestUrl();
                }
            });
            refreshBtn.addEventListener('click', loadDocs);
            loadDocs();
        </script>
    </body>
</html>
